version: 2.1

jobs:
  build-and-push-docker:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo

    steps:
      - checkout

      - setup_remote_docker:
          docker_layer_caching: true

      # Determine image version
      - run:
          name: Set image version
          command: |
            BASE_VERSION="1.0.0"

            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

            if [ "$CIRCLE_BRANCH" = "main" ]; then
              PATCH=$((PATCH + 1))
              IMAGE_VERSION="$MAJOR.$MINOR.$PATCH"
            else
              IMAGE_VERSION="$BASE_VERSION-dev.$CIRCLE_BUILD_NUM"
            fi

            echo "Using image version: $IMAGE_VERSION"
            echo "export IMAGE_VERSION=$IMAGE_VERSION" >> $BASH_ENV

      # Login to Docker Hub
      - run:
          name: Login to Docker Hub
          command: |
            echo $DOCKERHUB_TOKEN | docker login \
              -u $DOCKERHUB_USERNAME \
              --password-stdin

      # Build Docker image
      - run:
          name: Build Docker image
          command: |
            docker build \
              --build-arg NUGET_SOURCE_URL=https://nuget.pkg.github.com/simondoescoding/index.json \
              --build-arg NUGET_AUTH_TOKEN=$NUGET_AUTH_TOKEN \
              -t simonaspinall/esports-api-gateway:$IMAGE_VERSION \
              -t simonaspinall/esports-api-gateway:latest \
              -f Dockerfile \
              .

      # Push Docker image
      - run:
          name: Push Docker image
          command: |
            docker push simonaspinall/esports-api-gateway:$IMAGE_VERSION
            docker push simonaspinall/esports-api-gateway:latest

workflows:
  docker-build-and-publish:
    jobs:
      - build-and-push-docker:
          filters:
            branches:
              only:
                - main
                - development
